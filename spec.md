# K12 企业级教务管理系统 - 技术规格说明书 (Spec)

## 1. 项目概述
本项目旨在构建一个面向初高中（K12）场景的企业级教务管理系统。核心差异化在于适应新高考/中考背景下的**动态成绩分析**（选科差异）、**精细化权限管理**（年级/班级/学科维度）以及**低代码/零代码扩展能力**（应对临时性数据收集与流程）。

配套文档：
*   产品需求（页面/菜单/交互/数据接入点）：见 prd.md
*   权限矩阵与数据范围：见 rbac-matrix.md
*   接口清单（数据接入点）：见 api-contract.md

## 2. 核心业务实体与数据模型 (Schema Design)

### 2.1 用户与权限 (RBAC + Data Scope)
*   **User (用户)**: 基础信息（姓名、工号/学号、密码）。
*   **Role (角色)**: 系统管理员、年级管理员、班主任、科任老师、学生。
*   **Permission (权限)**: 菜单权限（页面可见性） + **数据权限**（Row-Level Security）。
    *   *数据权限规则示例*：
        *   `GRADE_ADMIN`: `WHERE grade_id = :user.grade_id`
        *   `CLASS_TEACHER`: `WHERE class_id = :user.class_id`
        *   `SUBJECT_TEACHER`: `WHERE subject_id = :user.subject_id AND class_id IN (:user.class_ids)`

### 2.2 教学组织架构与学生档案 (Student Profile)
*   **Grade (年级)**: 2023级、2024级（注意：年级是动态升级的，用入学年份标识）。
*   **Class (行政班)**: 高一(1)班、高一(2)班。用于行政管理、德育考勤。
*   **Subject (科目)**: 语文、数学、英语、物理、历史...（支持动态添加）。
*   **Dormitory (宿舍)**: 楼栋、楼层、房间号、床位号（混合宿舍支持）。
*   **Student (学生档案)**:
    *   **Core (不可变)**: 学号、姓名、性别、身份证号、入学年份。
    *   **Dynamic (可变)**: 当前班级、当前宿舍、当前座位号、走读/住宿状态。
    *   **History (档案快照)**: 记录每个学期的班级、宿舍、座位变动历史，确保成绩分析能回溯当时状态。
*   **MoralScore (德育量化)**:
    *   来源：教务处巡堂扣分、学生会/纪检部扣分、宿舍生活老师扣分。
    *   维度：课堂纪律、仪容仪表、宿舍内务、早操出勤。
    *   **预警规则**: 
        *   累计预警：学期累计扣分 > N。
        *   频次预警：7天内连续扣分 > M 次。
        *   阈值配置：管理员可按年级/班级配置上述阈值。


### 2.3 成绩与选科 (Advanced Analytics)
*   **Exam (考试批次)**: 2024-2025学年第一学期期中考。
    *   属性：名称、类型（月考/期中/期末）、学期、参与年级。
*   **ExamSubject (考试科目配置)**: 该次考试包含哪些科目，各科满分是多少（如：物理100，体育60）。
*   **Score (成绩记录)**: 
    *   字段：`student_id`, `exam_id`, `subject_id`, `score_value` (原始分), `rank_class` (班排), `rank_grade` (校排/级排)。
    *   *扩展*：支持赋分制（新高考转换分）。
*   **Analytics (分析指标)**:
    *   **基础指标**: 平均分、最高分、最低分、标准差。
    *   **分段统计**: 优秀率 (Top 10% / >85分)、及格率 (>60%)、低分率 (<40%)。
    *   **进退步**: 对比上次同类型考试的年级排名变化。
    *   **学科均衡度**: 雷达图展示偏科情况（物理强/历史弱）。
    *   **临界生**: 最近一次考试总分在“一本线/普高线”上下 N 分（可配置）区间的学生。
    *   **偏科生**: 单科排名与总分排名差异超过阈值（如：总排前10%，英语排后30%）。
    *   **重点关注**: 综合“临界生+偏科+德育预警”自动生成的聚合标签。



### 2.4 低代码引擎 (Low-Code Engine)
*   **DynamicForm (动态表单)**:
    *   `schema`: JSON结构，定义表单字段（类型、校验规则、布局）。
    *   `target`: 关联对象（如：学生档案扩展表、临时调查问卷）。
*   **Workflow (审批流)**:
    *   `nodes`: 审批节点（发起人 -> 班主任 -> 年级组长 -> 教务处）。
    *   `conditions`: 自动流转条件。
*   **开源低代码集成策略**:
    *   目标：优先复用开源低代码平台的表单/页面渲染能力，减少自研成本。
    *   集成方式：前端以 npm 组件方式嵌入渲染器；或以 iframe/micro-frontend 嵌入独立低代码应用。
    *   约束：所有数据源必须经过本系统鉴权与数据范围校验，低代码仅配置，不直连数据库。

## 3. 功能模块规划

### 3.1 综合管理后台 (Admin Dashboard)
*   **校务配置**: 学期管理、科目管理、教室/场地管理。
*   **用户中心**: 批量导入师生数据、角色分配、数据权限配置。
*   **低代码平台**: 表单设计器（拖拽式）、流程设计器。

### 3.2 教师/班主任工作台
*   **我的班级**: 学生名单、学生画像（成绩+德育+考勤）。
*   **成绩分析**: 
    *   班级概况（平均分、优秀率）。
    *   进退步分析（对比上次考试）。
    *   临界生预警。
*   **事务审批**: 请假审批、场地申请审批。

### 3.3 学生端 (Mobile/Web)
*   **查分**: 仅查看个人成绩、个人进退步曲线。
*   **选科**: 高一升高二时的选科意向填报。
*   **消息通知**: 学校公告、作业通知。

## 4. 技术栈选型

*   **前端**: React 18 + Vite + Ant Design 5 (企业级UI) + XRender (低代码表单渲染) + Recharts/ECharts (复杂图表)。
*   **后端**: NestJS (Node.js) - 适合处理JSON动态数据和元数据驱动架构。
*   **数据库**: MySQL 8.0 (本地部署) + Prisma ORM。
*   **缓存**: Redis (用于缓存高频访问的成绩排名和权限数据)。
*   **部署 (DevOps)**:
    *   **容器化**: Docker + Docker Compose (全栈一键拉起)。
    *   **网关**: Nginx (反向代理、静态资源服务)。
    *   **CI/CD**: GitHub Actions / GitLab CI (自动化构建镜像)。

### 4.1 成绩计算引擎库选型

针对成绩分析、排名计算、统计分析等核心功能，选用以下成熟库：

#### 统计分析库
*   **simple-statistics** (推荐)
    *   npm: `npm install simple-statistics`
    *   用途：均值、标准差、方差、中位数、百分位数、相关系数等基础统计
    *   特点：轻量级、零依赖、同时支持Node.js和浏览器
    *   GitHub: https://github.com/simple-statistics/simple-statistics

*   **jStat**
    *   npm: `npm install jstat`
    *   用途：矩阵运算、概率分布计算
    *   特点：轻量级、支持批量数据处理

#### 数据分析库（类Pandas）
*   **Arquero** (推荐)
    *   npm: `npm install arquero`
    *   用途：数据分组、聚合、排序、窗口函数
    *   特点：高性能、支持百万级数据、类dplyr API
    *   GitHub: https://github.com/uwdata/arquero

*   **Danfo.js**
    *   npm: `npm install danfojs-node`
    *   用途：完整DataFrame能力、机器学习扩展
    *   特点：JavaScript版Pandas、功能最全但包体积较大

#### 选型决策
| 场景 | 推荐方案 |
|------|----------|
| 基础统计（均分、标准差、百分位） | simple-statistics |
| 排名计算 | 自研 + simple-statistics |
| 班级/年级对比分析 | Arquero |
| 大规模数据处理 | Arquero |
| 赋分制计算 | 自研（按各省规则实现） |

#### 赋分制计算核心公式
```
R/r = (A-T)/(T-a)

其中：
- R: 赋分区间上限
- r: 赋分区间下限
- A: 原始分区间上限
- a: 原始分区间下限
- T: 考生原始分
```

赋分计算需按各省等级划分规则实现，核心步骤：
1. 按原始分排序确定排名百分比
2. 根据百分比确定等级区间
3. 按公式计算赋分

## 5. 信息架构与菜单规划 (IA / Menu)

### 5.1 终端形态
*   **管理端 (PC Web)**: 系统管理员、校级/年级管理员使用，重配置、重数据导入、重审计。
*   **教师端 (PC Web)**: 班主任/科任老师使用，重班级管理、重分析、轻配置。
*   **学生端 (H5/小程序)**: 重查询、重通知、重填报、轻编辑。
*   **内部分布屏 (TV/大屏)**: 滚动播报关键指标与预警，不提供复杂交互。

### 5.2 菜单结构（按角色）
*   **学生端**:
    *   首页（公告/通知、待办）
    *   成绩（单次成绩单、学期趋势、学科强弱）
    *   德育（量化明细、加扣分时间轴）
    *   填报（低代码表单入口：体温、报名、信息采集）
    *   我的（档案摘要、隐私设置）
*   **教师端 - 科任老师**:
    *   工作台（我的班级、待处理事项）
    *   成绩分析（任教学科：班级对比、分段统计、学科薄弱点）
    *   德育量化（课堂/巡堂事件录入或复核）
    *   通知发布（发给行政班）
    *   我的（个人资料、密码、操作日志摘要）
*   **教师端 - 班主任（在科任菜单基础上增加）**:
    *   班级管理（学生名单、座位、宿舍信息摘要）
    *   学生档案（360全景、学期/学年回溯）
    *   班级分析（班级总分/各科、进退步、临界生、优秀/及格/低分率）
    *   德育管理（扣分来源对账：巡堂/纪检/宿管）
    *   审批中心（请假、处分/表扬、其他流程）
*   **年级管理员**:
    *   考务中心（考试创建、科目满分、导入成绩、异常校验、排名计算、报表导出）
    *   年级分析（各班对比、学科贡献、临界生池、薄弱学科画像）
    *   德育量化（规则配置、事件录入/导入、统计报表）
    *   宿舍量化（混合宿舍、内务扣分、宿舍报表）
    *   审批中心（年级范围内流程处理）
*   **系统管理员**:
    *   组织与人员（年级/班级、用户导入、账号管理）
    *   角色权限（菜单权限、功能权限、数据范围权限）
    *   字典与规则（科目库、德育规则、分段规则、线位配置）
    *   低代码中心（表单、流程、报表、发布与权限）
    *   安全审计（登录/导入/修改成绩/权限变更审计）

### 5.3 页面布局约定
*   **PC Web**: 左侧菜单 + 顶部导航（学年学期切换、年级切换、全局搜索学生）+ 内容区。
*   **详情页**: 左侧基本信息卡 + 中间图表/列表 + 右侧标签与快捷操作。
*   **学生端**: 底部 Tab（首页/成绩/德育/填报/我的）。

### 5.4 核心页面（关键交互）
*   **学生360全景档案**: 成绩趋势 + 德育时间轴 + 档案回溯（按学期切换）。
*   **成绩分析页**: 班级对比（均分/优秀率/及格率/低分率）+ 分段构成 + 临界生列表。
*   **德育量化页**: 支持按来源（巡堂/纪检/宿舍）筛选，支持导出与复核。
*   **内部分布屏（滚动）**: 今日扣分Top班级、德育预警学生、成绩临界生、缺勤/迟到统计滚动播报。

## 6. 关键非功能需求
*   **安全性**: 成绩数据极其敏感，需做严格的接口鉴权和日志审计。
*   **性能**: 期末查分高峰期的并发支持（Redis缓存）。

# 考务中心与成绩分析 - 重构产品说明

## 一、核心痛点分析

### 1.1 教学场景的真实需求

**年级管理员的痛点：**
- 每次考试后，Excel成绩表格式混乱，需要大量人工清洗
- 成绩导入后，计算排名、分析数据耗时耗力
- 需要快速识别临界生、偏科生，但缺乏工具支撑
- 需要向校长汇报年级整体情况，但数据分散

**班主任的痛点：**
- 需要对比本班与其他班级的差距，但只能看到零散数据
- 需要关注班级临界生、进退步学生，但难以追踪
- 需要向家长反馈学生情况，但缺乏可视化报告
- 需要关注学科均衡度，识别偏科学生

**科任老师的痛点：**
- 只想看自己教的班级和学科，不想被无关信息干扰
- 需要了解所教班级的薄弱点，调整教学策略
- 需要对比不同行政班的教学效果
- 需要快速识别学科内的临界生

**学生的痛点：**
- 只能看到分数，看不到自己在年级/班级的位置
- 不知道自己的优势学科和薄弱学科
- 看不到自己的进步/退步趋势
- 缺乏针对性的学习建议

### 1.2 现有系统的不足

1. **视角混乱**：所有角色看到同样的页面，没有针对性
2. **数据孤立**：考务和成绩分析是两个割裂的模块
3. **分析浅显**：只有基础统计，缺乏深度洞察
4. **权限粗放**：无法精确控制"能看到什么数据"

---

## 二、重构架构：三层设计

### 2.1 第一层：考务中心（考试生命周期管理）

**定位**：考试从创建到成绩发布的全流程管理

**核心流程**：
```
创建考试 → 配置科目/满分 → 导入成绩 → 校验数据 → 确认发布 → 触发分析
```

**功能模块**：

#### 2.1.1 考试管理

**考试列表**：
- 按学期、年级、状态筛选
- 快速搜索考试名称
- 显示考试基本信息：名称、类型、时间、年级、科目数、状态

**创建考试**：
- 基础信息：
  - 考试名称（如：2024-2025学年第一学期期中考试）
  - 考试类型：月考、期中、期末、模拟考、周测、单元测
  - 考试时间：开始时间、结束时间
  - 参与年级：单选/多选
  - 学期：2024-2025-1、2024-2025-2
- 科目配置：
  - 选择科目（语文、数学、英语、物理、化学、生物、政治、历史、地理、体育等）
  - 设置各科满分（支持不同科目不同满分，如语文120分、数学120分、体育60分）
  - 设置优秀线、及格线、低分线（用于统计优秀率、及格率、低分率）
  - 设置是否参与总分统计（如体育可能不计入总分）
  - 设置是否参与排名（如考查科目）

**考试状态管理**：
```
草稿 → 未开始 → 进行中 → 已结束 → 已归档
```
- **草稿**：可编辑所有信息，可删除
- **未开始**：已发布，等待考试开始，可修改配置
- **进行中**：考试期间，锁定配置，可录入成绩
- **已结束**：考试结束，成绩录入完成，触发分析计算
- **已归档**：数据锁定，仅可查看，不可修改

**考试模板复用**：
- 基于历史考试快速创建新考试
- 复用科目配置、满分设置、分数线设置
- 支持保存为自定义模板

**考试日历视图**：
- 月视图展示所有考试安排
- 按年级、科目筛选
- 冲突检测（同一班级同一时间多个考试）

#### 2.1.2 成绩导入（重点优化）
- **模板下载**：按考试生成标准Excel模板
- **智能校验**：
  - 学号是否存在
  - 科目列是否匹配
  - 分数是否超过满分
  - 缺考标记识别
  - 重复数据检测
- **差异预览**：显示校验结果，标红错误行
- **确认入库**：支持回滚

#### 2.1.3 成绩管理
- 成绩列表：按班级、科目筛选
- 单条修改：支持更正（留痕审计）
- 批量导出：成绩单、班级对比表

---

### 2.2 第二层：成绩分析（多角色视角）

**核心设计原则**：同一数据源，不同视角呈现

#### 2.2.1 年级视角（年级管理员/校级领导）

**页面结构设计**：

```
┌─────────────────────────────────────────────────────────────────┐
│  年级总览 - 2024-2025学年第一学期期中考试                        │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐   │
│  │ 参考人数 │ │ 年级均分 │ │ 优秀率  │ │ 及格率  │ │ 标准差  │   │
│  │   356   │ │  654.2  │ │  23.5%  │ │  78.2%  │ │  45.3   │   │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘   │
├─────────────────────────────────────────────────────────────────┤
│  [班级对比] [分数段统计] [学科分析] [临界生池] [偏科生识别]      │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  （当前选中标签页的报表内容）                                    │
│                                                                 │
│  [导出Excel] [打印]                                             │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

**顶部数据卡片（快速概览）**

| 指标 | 说明 |
|------|------|
| 参考人数 | 应考人数 - 缺考人数 |
| 年级均分 | 全年级平均分 |
| 最高分 | 年级最高分 |
| 最低分 | 年级最低分 |
| 优秀率 | ≥优秀线人数占比 |
| 及格率 | ≥及格线人数占比 |
| 低分率 | ≤低分线人数占比 |
| 标准差 | 分数离散程度 |

---

**标签页1：班级对比（学科维度）**

*基于您提供的表格1设计：*

**表格1：学科班级对比表（按学科展示各班数据）**

| 班级 | 任课教师 | 应考人数 | 缺考人数 | 参考人数 | 最高分 | 最低分 | 平均分 | 优秀数 | 优秀率 | 及格数 | 及格率 | 低分数 | 低分率 | 满分 | 班级排名 | 折分排名 |
|------|---------|---------|---------|---------|--------|--------|--------|--------|--------|--------|--------|--------|--------|------|---------|---------|

**展示维度（每科一张表）**：
- **基础统计**：
  - 应考人数、缺考人数、参考人数
  - 最高分、最低分、平均分
  - 满分（显示在表头）
- **分段统计**：
  - 优秀数/率（≥优秀线，如≥96分）
  - 及格数/率（≥及格线，如≥72分）
  - 低分数/率（≤低分线，如≤36分）
- **排名**：
  - 班级排名（该学科在全年级的排名）
  - 折分排名（折算后的排名，用于不同满分科目的对比）
- **年级汇总行**：
  - 年级总体情况：应考总人数、缺考总人数、参考总人数
  - 年级最高分、最低分、平均分
  - 年级优秀率、及格率、低分率

**交互功能**：
- 按学科切换查看（语文、数学、英语...）
- 按班级筛选（只看某些班级）
- 导出Excel（与表格格式一致）
- 点击班级查看该班该科详细分析

---

**页面：分数段统计（年级视角）**

*基于您提供的表格2设计：*

**表格2：分数段人数分布表**

| 班级 | 任课教师 | 应考人数 | 缺考人数 | 参考人数 | ≥110 | ≥100 | ≥96 | ≥72 | ≥60 | ≥48 | ≥36 | <36 |
|------|---------|---------|---------|---------|------|------|-----|-----|-----|-----|-----|-----|

**分数段设置（可配置）**：
- 支持自定义分数段区间
- 默认分数段（以满分120为例）：
  - ≥110（顶尖）
  - ≥100（优秀）
  - ≥96（良好）
  - ≥72（及格）
  - ≥60（合格）
  - ≥48（待提高）
  - ≥36（关注）
  - <36（低分）

**展示内容**：
- 每科一张表，显示各班在各分数段的人数分布
- 年级汇总行：显示全年级在各分数段的总人数
- 可视化：堆叠柱状图展示各班分数段分布

**用途**：
- 快速识别各班在不同水平段的学生分布
- 发现"尖子生集中班"和"后进生集中班"
- 为分层教学提供数据支撑

**页面：学科分析**
- 学科贡献度：哪科拉高了/拉低了班级均分
- 学科均衡度：各班学科强弱分布
- 薄弱学科识别：与年级均分差距大的班级

**页面：临界生池（核心功能）**
- 线位配置：一本线、普高线、自定义线
- 临界生列表：
  - 线上生（距离线位 X 分以内）
  - 线下生（距离线位 X 分以内）
  - 支持按班级、学科筛选
- 重点关注：标记需要干预的学生

**页面：偏科生识别**
- 偏科规则：单科排名与总分排名差异超过阈值
- 偏科类型：
  - 优势学科（单科排名远高于总分排名）
  - 薄弱学科（单科排名远低于总分排名）
- 干预建议：自动生成学科提升建议

#### 2.2.2 班级视角（班主任）

**页面结构设计**：

```
┌─────────────────────────────────────────────────────────────────┐
│  班级分析 - 初二(1)班 - 2024-2025学年第一学期期中考试            │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐   │
│  │ 班级均分 │ │ 年级排名 │ │ 优秀率  │ │ 及格率  │ │ 与年级差 │   │
│  │  654.2  │ │   第3名  │ │  50.0%  │ │  83.3%  │ │  +15.3  │   │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘   │
├─────────────────────────────────────────────────────────────────┤
│  [学科统计] [学生排名] [分数段分布] [临界生] [偏科生] [进退步]   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  （当前选中标签页的报表内容）                                    │
│                                                                 │
│  [导出Excel] [打印成绩单]                                        │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

**顶部数据卡片（快速概览）**

| 指标 | 说明 |
|------|------|
| 班级均分 | 班级总分平均分 |
| 年级排名 | 班级总分在年级的排名 |
| 优秀人数/率 | ≥优秀线人数及占比 |
| 及格人数/率 | ≥及格线人数及占比 |
| 低分人数/率 | ≤低分线人数及占比 |
| 与年级差 | 班级均分与年级均分的差距 |

---

**标签页1：学科统计（班级学科统计表）**

*基于您提供的表格4设计：*

**表格4：班级学科统计表**

| 科目 | 参考人数 | 最高分 | 最低分 | 平均分 | 合格人数 | 合格率 | 优秀人数 | 优秀率 | 低分人数 | 低分率 | 折分 |
|------|---------|--------|--------|--------|----------|--------|----------|--------|----------|--------|------|
| 语文 | 6 | 105 | 96 | 100.2 | 6 | 100.0% | 6 | 100.0% | 0 | 0.0% | 100.1 |
| 数学 | 6 | 108 | 85 | 97.2 | 6 | 100.0% | 4 | 66.7% | 0 | 0.0% | 92.2 |
| ... | ... | ... | ... | ... | ... | ... | ... | ... | ... | ... | ... |
| **总分** | 6 | 707.5 | 599 | 654.2 | 5 | 83.3% | 3 | 50.0% | - | - | - |

**展示内容**：
- **学科维度**：每行一个学科（语文、数学、英语、物理、化学、生物、政治、历史、地理、体育）
- **基础统计**：参考人数、最高分、最低分、平均分
- **分段统计**：
  - 合格人数/率（≥及格线）
  - 优秀人数/率（≥优秀线）
  - 低分人数/率（≤低分线）
- **折分**：折算后的分数（用于不同满分科目的对比）
- **总分行**：班级总分的统计情况

**与年级对比**：
- 显示班级平均分与年级平均分的差距（如：+5.3分 或 -3.2分）
- 显示班级排名（该学科在全年级的排名）

---

**标签页2：学生排名（成绩明细表）**

*基于您提供的表格3设计：*

**表格3：学生成绩明细表**

| 班级 | 学号 | 姓名 | 语文得分 | 语文年级排名 | 数学得分 | 数学年级排名 | 英语得分 | 英语年级排名 | ... | 总分 | 总分年级排名 |
|------|------|------|----------|--------------|----------|--------------|----------|--------------|-----|------|--------------|
| 初二(1)班 | 20240115 | 方楚怡 | 105 | 1 | 101 | 7 | 104.5 | 2 | ... | 707.5 | 1 |
| 初二(1)班 | 20240153 | 张美乐 | 102 | 3 | 96 | 9 | 92.5 | 9 | ... | 683.5 | 4 |
| ... | ... | ... | ... | ... | ... | ... | ... | ... | ... | ... | ... |

**展示维度**：
- **学生信息**：班级、学号、姓名
- **各科成绩**：
  - 得分（原始分数）
  - 年级排名（该科在全年级的排名）
  - 班排（该科在班级的排名，可选显示）
- **总分**：
  - 总分（各科得分之和）
  - 年级排名（总分在全年级的排名）
  - 班排（总分在班级的排名）

**排序与筛选**：
- 默认按总分年级排名排序
- 支持按单科排名排序
- 支持按姓名、学号搜索
- 支持筛选：只看前10名、只看后10名、只看临界生等

**交互功能**：
- 点击学生姓名查看学生档案（成绩趋势、德育记录等）
- 点击排名查看该分数段的其他学生
- 导出成绩单（PDF/Excel）
- 批量打印成绩单

---

**标签页3：分数段分布**

*基于表格2的班级视角：*

**展示内容**：
- 本班在各科的分数段人数分布
- 与年级平均分布的对比
- 可视化：柱状图展示本班 vs 年级平均

---

**标签页4：临界生关注**
- 本班临界生列表
- 临界生详情：总分、各科分数、距离线位
- 干预记录：班主任的谈话记录、措施

---

**标签页5：偏科生关注**
- 本班偏科生列表
- 偏科详情：优势学科、薄弱学科
- 提升建议：针对性的学习建议

---

**标签页6：进退步分析**
- 对比上次考试，本班学生的排名变化
- 进步生名单（排名上升超过阈值）
- 退步生名单（排名下降超过阈值）
- 可视化：进退步趋势图

#### 2.2.3 学科视角（科任老师）

**页面：学科总览**
- 学科指标：
  - 年级均分、最高分、最低分
  - 各班均分排名
  - 优秀率 / 及格率 / 低分率

**页面：班级对比**
- 所教行政班对比：
  - 均分对比
  - 分段人数对比
  - 进退步对比
- 可视化：柱状图、箱线图

**页面：学生排名**
- 学科排名：班排、级排
- 分数分布：分数段人数
- 临界生：学科内的临界生（如物理一本线临界）

**页面：薄弱点分析（未来扩展）**
- 知识点得分率（需接题库）
- 题型得分率（选择题/填空题/解答题）
- 教学建议：基于数据的教学调整建议

#### 2.2.4 学生视角（学生/家长）

**页面结构设计**：

```
┌─────────────────────────────────────────────────────────────────┐
│  我的成绩 - 方楚怡 - 2024-2025学年第一学期期中考试               │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐   │
│  │ 总分    │ │ 班级排名 │ │ 年级排名 │ │ 百分位  │ │ 进退步  │   │
│  │  707.5  │ │   第1名  │ │   第4名  │ │  前5%   │ │  ↑3名   │   │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘   │
├─────────────────────────────────────────────────────────────────┤
│  [我的成绩单] [班级排名] [学科强弱] [进步曲线] [学习建议]        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  （当前选中标签页的内容）                                        │
│                                                                 │
│  [下载成绩单PDF]                                                 │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

**顶部数据卡片（快速概览）**

| 指标 | 说明 |
|------|------|
| 总分 | 各科得分之和 |
| 班级排名 | 总分在班级的排名 |
| 年级排名 | 总分在年级的排名 |
| 百分位 | 在全年级的位置（如前5%、前10%） |
| 进退步 | 对比上次考试的排名变化 |

---

**标签页1：我的成绩单**

*基于表格3的学生个人视角：*

**个人成绩单**：

| 科目 | 得分 | 满分 | 班排 | 级排 | 与班级均分差距 | 与年级均分差距 |
|------|------|------|------|------|----------------|----------------|
| 语文 | 105 | 120 | 1 | 3 | +4.8 | +3.2 |
| 数学 | 101 | 120 | 3 | 9 | -1.5 | -2.3 |
| 英语 | 104.5 | 120 | 2 | 5 | +2.1 | +1.8 |
| ... | ... | ... | ... | ... | ... | ... |
| **总分** | **707.5** | **840** | **1** | **4** | **+23.5** | **+15.3** |

**展示内容**：
- **各科成绩**：得分、满分、班排、级排
- **对比分析**：与班级均分、年级均分的差距（正数表示高于平均，负数表示低于平均）
- **总分统计**：总分、班排、级排、与平均分的差距
- **百分位**：显示在全年级的位置（如前5%、前10%等）

**成绩解读**：
- 优势学科标记（班排名前3）
- 薄弱学科标记（班排名后3）
- 临界学科提醒（距离及格线/优秀线较近）

---

**页面：班级总分排名**

*基于表格1右侧的班级总分排名：*

**班级总分排名表**：

| 排名 | 姓名 | 总分 | 与第一名差距 | 与班级均分差距 |
|------|------|------|--------------|----------------|
| 1 | 方楚怡 | 707.5 | - | +53.3 |
| 2 | 张美乐 | 683.5 | -24.0 | +29.3 |
| 3 | 廖日凤 | 662.5 | -45.0 | +8.3 |
| ... | ... | ... | ... | ... |
| 班级均分 | - | 654.2 | - | - |

**展示内容**：
- 本班所有学生的总分排名
- 与第一名的分数差距
- 与班级均分的差距
- 自己的排名高亮显示

---

**页面：学科强弱分析**
- 学科雷达图：各科在班级的位置
- 优势学科：排名靠前的学科（班排名前30%）
- 薄弱学科：排名靠后的学科（班排名后30%）
- 均衡度评估：是否偏科（标准差分析）

---

**页面：进步曲线**
- 总分趋势：历次考试总分变化曲线
- 学科趋势：各学科分数变化曲线
- 排名趋势：班排、级排变化曲线
- 进退步标记：明显进步/退步的考试

---

**页面：学习建议**
- 基于数据的个性化建议：
  - 保持优势学科（继续保持的学科）
  - 提升薄弱学科（需要重点关注的学科）
  - 临界学科提醒（距离优秀线/及格线较近的学科）
  - 目标设定建议（下次考试可达到的排名）

---

### 2.3 第三层：数据权限引擎

**核心原则**：数据范围决定能看到什么

#### 2.3.1 权限模型

```
角色 + 数据范围 = 可见数据
```

**数据范围类型**：
- **年级范围**：能看到整个年级的数据
- **班级范围**：只能看到指定班级的数据
- **学科范围**：只能看到指定学科的数据
- **学生范围**：只能看到指定学生的数据（本人）

#### 2.3.2 角色与数据范围映射

| 角色 | 默认数据范围 | 说明 |
|------|-------------|------|
| 系统管理员 | 全校 | 可切换查看任意年级 |
| 年级管理员 | 本年级 | 只能看到自己管理的年级 |
| 班主任 | 本班 | 只能看到自己带的班级 |
| 科任老师 | 所教班级 + 所教学科 | 只能看到任教班级和学科 |
| 学生 | 本人 | 只能看到自己的数据 |

#### 2.3.3 动态过滤

**实现方式**：
- API 层统一过滤：根据用户的数据范围自动添加 WHERE 条件
- 前端动态渲染：根据权限显示/隐藏页面和功能

**示例**：
```typescript
// 班主任查询成绩
const scores = await prisma.scores.findMany({
  where: {
    examId: 'xxx',
    students: {
      classId: user.dataScope.classIds[0], // 只能查本班
    },
  },
});

// 科任老师查询成绩
const scores = await prisma.scores.findMany({
  where: {
    examId: 'xxx',
    subjectId: user.dataScope.subjectIds[0], // 只能查所教学科
    students: {
      classId: { in: user.dataScope.classIds }, // 只能查所教班级
    },
  },
});
```

---

## 三、关键功能详细设计

### 3.1 成绩导入流程（优化版）

```
Step 1: 下载模板
        ↓
Step 2: 填写成绩（Excel）
        ↓
Step 3: 上传文件
        ↓
Step 4: 智能校验（实时）
        - 学号格式检查
        - 学号存在性检查
        - 科目列匹配检查
        - 满分超限检查
        - 缺考标记识别
        - 重复数据检查
        ↓
Step 5: 预览差异（标红错误）
        ↓
Step 6: 确认入库（可回滚）
        ↓
Step 7: 触发计算（排名、分析）
```

**校验规则**：
| 校验项 | 处理方式 | 错误提示 |
|--------|---------|---------|
| 学号不存在 | 标红，不允许入库 | "学号 XXX 不存在" |
| 分数 > 满分 | 标红，需确认 | "物理分数 105 超过满分 100" |
| 科目列不匹配 | 标红，需修正 | "缺少化学列" |
| 重复学号 | 标红，去重 | "学号 XXX 重复出现" |
| 缺考标记 | 自动识别 | "标记为缺考，分数记为0" |

### 3.2 临界生识别算法

**定义**：总分在目标线位上下浮动范围内的学生

**算法**：
```typescript
const isCritical = (studentScore: number, lineScore: number, range: number) => {
  const diff = Math.abs(studentScore - lineScore);
  return diff <= range;
};

// 分类
const getCriticalType = (studentScore: number, lineScore: number) => {
  if (studentScore >= lineScore) return 'above'; // 线上临界
  return 'below'; // 线下临界
};
```

**展示维度**：
- 按线位筛选：一本线、普高线、自定义线
- 按类型筛选：线上生、线下生
- 按班级筛选：只看本班
- 按距离排序：距离线位最近优先

### 3.3 偏科生识别算法

**定义**：某学科排名与总分排名差异超过阈值的学生

**算法**：
```typescript
const isImbalanced = (
  subjectRankPercentile: number, // 学科排名百分位（0-100）
  totalRankPercentile: number,    // 总分排名百分位（0-100）
  threshold: number               // 阈值（如20%）
) => {
  const diff = Math.abs(subjectRankPercentile - totalRankPercentile);
  return diff > threshold;
};

// 分类
const getImbalanceType = (
  subjectRankPercentile: number,
  totalRankPercentile: number
) => {
  if (subjectRankPercentile > totalRankPercentile + 20) return 'strong'; // 优势学科
  if (subjectRankPercentile < totalRankPercentile - 20) return 'weak';   // 薄弱学科
  return 'balanced';
};
```

**展示维度**：
- 偏科类型：优势学科、薄弱学科
- 偏科程度：差异百分比
- 干预建议：针对性的提升建议

### 3.4 进退步分析算法

**定义**：对比两次考试，排名变化超过阈值的学生

**算法**：
```typescript
const getProgressType = (
  currentRank: number,
  previousRank: number,
  threshold: number = 10
) => {
  const change = previousRank - currentRank; // 正数表示进步
  
  if (change > threshold) return { type: 'up', change };      // 明显进步
  if (change < -threshold) return { type: 'down', change };  // 明显退步
  return { type: 'stable', change };                         // 保持稳定
};
```

**展示维度**：
- 进退步类型：进步、退步、稳定
- 变化幅度：排名变化位数
- 可视化：进退步趋势图

---

## 四、页面结构规划

### 4.1 考务中心

```
考务中心/
├── 考试管理/
│   ├── 考试列表
│   ├── 创建考试
│   └── 考试详情
├── 成绩导入/
│   ├── 选择考试
│   ├── 下载模板
│   ├── 上传文件
│   ├── 校验预览
│   └── 确认入库
└── 成绩管理/
    ├── 成绩列表
    └── 成绩导出
```

### 4.2 成绩分析（按角色）

```
成绩分析/
├── 年级视角/
│   ├── 年级总览
│   ├── 班级对比
│   ├── 学科分析
│   ├── 临界生池
│   └── 偏科生识别
├── 班级视角/
│   ├── 班级总览
│   ├── 学生排名
│   ├── 学科分析
│   ├── 临界生关注
│   └── 偏科生关注
├── 学科视角/
│   ├── 学科总览
│   ├── 班级对比
│   └── 学生排名
└── 学生视角/
    ├── 我的成绩
    ├── 学科强弱
    ├── 进步曲线
    └── 学习建议
```

---

## 五、技术实现要点

### 5.1 数据权限实现

**方案**：中间件统一过滤

```typescript
// 数据权限中间件
@Injectable()
export class DataScopeMiddleware implements NestMiddleware {
  use(req: Request, res: Response, next: NextFunction) {
    const user = req.user;
    
    // 根据用户角色和数据范围，生成查询条件
    req.dataScope = this.buildDataScope(user);
    
    next();
  }
  
  buildDataScope(user: User) {
    switch (user.role) {
      case 'GRADE_ADMIN':
        return { gradeId: user.gradeId };
      case 'CLASS_TEACHER':
        return { classId: user.classId };
      case 'SUBJECT_TEACHER':
        return { 
          subjectId: user.subjectId,
          classIds: user.classIds 
        };
      case 'STUDENT':
        return { studentId: user.studentId };
      default:
        return {};
    }
  }
}
```

### 5.2 成绩计算优化

**方案**：异步任务队列

```typescript
// 导入成绩后触发计算任务
@OnEvent('scores.imported')
async handleScoresImported(event: ScoresImportedEvent) {
  // 1. 计算排名（班级排名、年级排名）
  await this.rankCalculator.calculate(event.examId);
  
  // 2. 计算分析指标（均分、优秀率等）
  await this.analyticsCalculator.calculate(event.examId);
  
  // 3. 识别临界生
  await this.criticalStudentCalculator.calculate(event.examId);
  
  // 4. 识别偏科生
  await this.imbalancedStudentCalculator.calculate(event.examId);
}
```

### 5.3 缓存策略

**方案**：Redis 缓存高频数据

```typescript
// 缓存年级分析数据（5分钟）
@Cacheable({ ttl: 300, key: 'analytics:grade:{examId}' })
async getGradeAnalytics(examId: string) {
  return this.calculateGradeAnalytics(examId);
}

// 缓存班级分析数据（5分钟）
@Cacheable({ ttl: 300, key: 'analytics:class:{examId}:{classId}' })
async getClassAnalytics(examId: string, classId: string) {
  return this.calculateClassAnalytics(examId, classId);
}
```

---

## 六、实施路线图

### Phase 1：考务中心（基础）
- [ ] 考试管理（创建、配置、发布）
- [ ] 成绩导入（模板、校验、入库）
- [ ] 成绩管理（列表、导出）

### Phase 2：成绩分析（年级视角）
- [ ] 年级总览
- [ ] 班级对比
- [ ] 学科分析
- [ ] 临界生池
- [ ] 偏科生识别

### Phase 3：成绩分析（班级视角）
- [ ] 班级总览
- [ ] 学生排名
- [ ] 学科分析
- [ ] 临界生关注
- [ ] 偏科生关注

### Phase 4：成绩分析（学科视角）
- [ ] 学科总览
- [ ] 班级对比
- [ ] 学生排名

### Phase 5：成绩分析（学生视角）
- [ ] 我的成绩
- [ ] 学科强弱
- [ ] 进步曲线
- [ ] 学习建议

### Phase 6：数据权限
- [ ] 数据范围权限模型
- [ ] 角色与数据范围绑定
- [ ] API 层统一过滤

---

## 七、总结

### 核心改进点

1. **视角分离**：按角色（年级/班级/学科/学生）设计独立页面
2. **数据权限**：精确控制"能看到什么数据"
3. **深度分析**：临界生、偏科生、进退步等教学痛点功能
4. **流程闭环**：考务 → 导入 → 分析 → 干预 → 追踪

### 关键成功因素

1. **数据准确性**：导入校验、排名计算必须准确
2. **性能优化**：大数据量下的查询性能
3. **用户体验**：教师使用门槛低，学生查看直观
4. **权限安全**：成绩数据敏感，权限控制必须严格
